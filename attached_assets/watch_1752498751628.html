<!DOCTYPE html>
<html>
<head>
    <title>Player - MOinMirror</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            background: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #player-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        #video-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 10;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: #e50914;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            color: #e50914;
            font-size: 16px;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 20;
            transition: background 0.3s;
        }
        
        .back-button:hover {
            background: rgba(229, 9, 20, 0.8);
        }
        
        .source-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="player-container">
        <button class="back-button" onclick="history.back()">← Back</button>
        <div class="loading" id="loading">Loading stream...</div>
        <video id="video" controls preload="none" style="display: none;"></video>
        <iframe id="video-iframe" style="display: none;" allowfullscreen 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                sandbox="allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-top-navigation"></iframe>
        <div class="source-info" id="source-info" style="display:none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const imdbId = "{{ imdb_id }}";
        const video = document.getElementById('video');
        const iframe = document.getElementById('video-iframe');
        const loading = document.getElementById('loading');
        const sourceInfo = document.getElementById('source-info');
        
        // Multiple sources to try in order (NetMirror-style fast sources)
        const sources = [
            { name: 'MultiEmbed', key: 'auto' },
            { name: 'VidSrc', key: 'vidsrc' },
            { name: 'MixDrop', key: 'mixdrop' }
        ];
        
        let currentSource = 0;
        let hls = null;
        
        console.log(`Starting video playback for IMDb ID: ${imdbId}`);
        
        function showError(msg) {
            loading.innerHTML = `<div class="error">❌ ${msg}</div>`;
            console.error('Player error:', msg);
        }
        
        function showLoading(msg) {
            loading.innerHTML = msg;
            loading.style.display = 'block';
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        function updateSourceInfo(sourceName) {
            sourceInfo.textContent = `Source: ${sourceName}`;
            sourceInfo.style.display = 'block';
        }
        
        function tryNextSource() {
            if (currentSource >= sources.length) {
                showError("All video sources failed. Please try again later.");
                return;
            }
            
            const source = sources[currentSource];
            console.log(`Trying source ${currentSource + 1}/${sources.length}: ${source.name}`);
            
            showLoading(`Loading from ${source.name}...`);
            
            fetch(`/api/stream/${imdbId}?source=${source.key}`)
                .then(response => {
                    console.log('Stream API response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Stream API response:', data);
                    
                    if (data.success && data.m3u8) {
                        console.log('Stream URL received:', data.m3u8);
                        initPlayer(data.m3u8, source.name);
                    } else {
                        console.warn(`Source ${source.name} failed:`, data.error);
                        currentSource++;
                        setTimeout(tryNextSource, 1000); // Small delay before trying next source
                    }
                })
                .catch(error => {
                    console.error(`Error fetching from ${source.name}:`, error);
                    currentSource++;
                    setTimeout(tryNextSource, 1000);
                });
        }
        
        function initPlayer(streamUrl, sourceName) {
            console.log('Initializing player with URL:', streamUrl);
            
            // Clean up any existing HLS instance
            if (hls) {
                hls.destroy();
            }
            
            updateSourceInfo(sourceName);
            
            // Check if it's an embed URL (iframe)
            if (streamUrl.includes('embed') || streamUrl.includes('vidsrc') || streamUrl.includes('streamwish') || streamUrl.includes('2embed') || streamUrl.includes('multiembed') || streamUrl.includes('moviesapi') || streamUrl.includes('autoembed')) {
                console.log('Detected embed URL, using iframe');
                
                // Hide video element and show iframe
                video.style.display = 'none';
                iframe.style.display = 'block';
                iframe.src = streamUrl;
                
                hideLoading();
                
                // Handle iframe load with better error detection
                iframe.onload = function() {
                    console.log('Iframe loaded successfully');
                    hideLoading();
                    
                    // Check if iframe content has loaded properly after a short delay
                    setTimeout(() => {
                        try {
                            // Try to access iframe content to check if it's working
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            if (iframeDoc) {
                                console.log('Iframe content accessible');
                            } else {
                                console.log('Iframe content not accessible (cross-origin) - this is normal');
                            }
                        } catch (e) {
                            console.log('Iframe cross-origin protection active - this is normal');
                        }
                    }, 2000);
                };
                
                iframe.onerror = function() {
                    console.error('Iframe failed to load');
                    currentSource++;
                    setTimeout(tryNextSource, 1000);
                };
                
                // Add timeout for iframe loading (reduced for faster fallback)
                setTimeout(() => {
                    if (loading.style.display !== 'none') {
                        console.log('Iframe taking too long to load, trying next source');
                        currentSource++;
                        setTimeout(tryNextSource, 500);
                    }
                }, 8000);
                
                return;
            }
            
            // Check if it's an M3U8 file (HLS stream)
            if (streamUrl.includes('.m3u8')) {
                console.log('Detected M3U8 stream, using HLS.js');
                
                // Show video element and hide iframe
                video.style.display = 'block';
                iframe.style.display = 'none';
                
                if (Hls.isSupported()) {
                    console.log('HLS.js is supported, initializing...');
                    hls = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS manifest parsed successfully');
                        hideLoading();
                        
                        // Auto-play with user interaction check
                        video.play().catch(e => {
                            console.log('Auto-play prevented, user interaction required');
                            showLoading('Click to play video');
                            loading.style.cursor = 'pointer';
                            loading.onclick = () => {
                                video.play();
                                hideLoading();
                            };
                        });
                    });
                    
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS error:', event, data);
                        
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.log('Network error, trying to recover...');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.log('Media error, trying to recover...');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.log('Fatal error, trying next source...');
                                    currentSource++;
                                    tryNextSource();
                                    break;
                            }
                        }
                    });
                    
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    console.log('Using native HLS support');
                    video.src = streamUrl;
                    
                    video.addEventListener('loadedmetadata', function() {
                        console.log('Video metadata loaded');
                        hideLoading();
                        video.play().catch(e => {
                            console.log('Auto-play prevented');
                            showLoading('Click to play video');
                            loading.style.cursor = 'pointer';
                            loading.onclick = () => {
                                video.play();
                                hideLoading();
                            };
                        });
                    });
                    
                    video.addEventListener('error', function(e) {
                        console.error('Video error:', e);
                        currentSource++;
                        tryNextSource();
                    });
                    
                } else {
                    showError("Your browser doesn't support HLS video playback");
                }
            } else {
                // Handle regular MP4 or other video formats
                console.log('Detected regular video format, using direct playback');
                video.src = streamUrl;
                
                video.addEventListener('loadedmetadata', function() {
                    console.log('Video metadata loaded');
                    hideLoading();
                    video.play().catch(e => {
                        console.log('Auto-play prevented');
                        showLoading('Click to play video');
                        loading.style.cursor = 'pointer';
                        loading.onclick = () => {
                            video.play();
                            hideLoading();
                        };
                    });
                });
                
                video.addEventListener('error', function(e) {
                    console.error('Video error:', e);
                    currentSource++;
                    tryNextSource();
                });
            }
        }
        
        // Video event listeners for debugging
        video.addEventListener('loadstart', () => console.log('Video load started'));
        video.addEventListener('canplay', () => console.log('Video can play'));
        video.addEventListener('playing', () => console.log('Video is playing'));
        video.addEventListener('waiting', () => console.log('Video is waiting'));
        video.addEventListener('ended', () => console.log('Video ended'));
        
        // Start trying sources
        console.log('Starting source attempts...');
        tryNextSource();
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (hls) {
                hls.destroy();
            }
        });
    </script>
</body>
</html>
