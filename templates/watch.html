<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Watch Movie - Mushh's Galaxy</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/css/style.css" />

    <!-- hls.js for .m3u8 playback -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* Ensure video and iframe fill container */
        .video-player,
        .iframe-player {
            width: 100% !important;
            height: 500px;
            max-height: 80vh;
            background: black;
        }

        /* Loading spinner container */
        .player-loading {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 500px;
            max-height: 80vh;
            background-color: #000;
            color: #fff;
        }

        /* Error container */
        .player-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 500px;
            max-height: 80vh;
            background-color: #111;
            color: #f44336;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-film text-danger me-2"></i>
                <span class="brand-text">Mushh's Galaxy</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/" data-section="home">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="watch">
                            <i class="fas fa-play me-1"></i>Watch
                        </a>
                    </li>
                </ul>
                <div class="navbar-nav">
                    <button class="btn btn-outline-light btn-sm" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-1"></i>Back
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Spacer to offset fixed navbar -->
    <div style="height: 70px;"></div>

    <!-- Video Player Section -->
    <section class="player-section mb-4">
        <div class="container my-5">
            <div class="ratio ratio-16x9" style="background:#000;">
                <iframe
                    id="movie-embed"
                    allowfullscreen
                    allow="autoplay; encrypted-media"
                    style="width:100%; height:100%; border:none; background:#000;"
                ></iframe>
            </div>
        </div>
    </section>

    <!-- Movie Info Section -->
    <section class="movie-info-section mb-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <div class="movie-details">
                        <h1 id="movie-title">Loading...</h1>
                        <div class="movie-meta mb-3">
                            <span id="movie-year" class="badge bg-secondary me-1">-</span>
                            <span id="movie-rating" class="badge bg-warning me-1">-</span>
                            <span id="movie-runtime" class="badge bg-info">-</span>
                        </div>
                        <p id="movie-plot" class="movie-plot">Loading movie information...</p>
                        <div class="movie-details-grid">
                            <div class="detail-item"><strong>Director:</strong> <span id="movie-director">-</span></div>
                            <div class="detail-item"><strong>Genre:</strong> <span id="movie-genre">-</span></div>
                            <div class="detail-item"><strong>Cast:</strong> <span id="movie-actors">-</span></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="movie-poster text-center">
                        <img id="movie-poster-img" src="" alt="Movie Poster" class="img-fluid rounded shadow" />
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Source Selection Buttons -->
    <section class="source-selection mb-5">
        <div class="container">
            <h3>Select Streaming Source</h3>
            <div id="source-buttons" class="source-buttons d-flex flex-wrap gap-2">
                <!-- Source buttons rendered by JS -->
            </div>
            <div id="source-status-msg" class="small text-secondary mt-2"></div>
        </div>
    </section>

    <!-- Debug Info, hidden by default -->
    <section class="debug-info d-none">
        <div class="container">
            <h4>Debug Information</h4>
            <div class="debug-panel">
                <div class="debug-item"><strong>IMDb ID:</strong> <span id="debug-imdb">{{ imdb_id }}</span></div>
                <div class="debug-item"><strong>Current Source:</strong> <span id="debug-source">-</span></div>
                <div class="debug-item"><strong>Stream URL:</strong> <span id="debug-url">-</span></div>
                <div class="debug-item"><strong>Player Type:</strong> <span id="debug-player">-</span></div>
            </div>
        </div>
    </section>

    <!-- Add or update Play button to ensure it calls initializePlayer and loadStream -->
    <button class="btn btn-primary btn-lg mt-3" onclick="playMovie()">
        <i class="fas fa-play me-2"></i>Play Movie
    </button>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Your player.js script -->
    <script src="/static/js/player.js"></script>
    <script>
      const imdbId = "{{ imdb_id }}";
      document.addEventListener('DOMContentLoaded', function() {
        initializePlayer(imdbId);
      });
    </script>
    <script>
document.addEventListener("DOMContentLoaded", function () {
  var imdbId = "{{ imdb_id }}";
  // Optimized provider order: fastest and most reliable first
  var providers = [
    "https://vidsrc.xyz/embed/" + imdbId,        // Usually fastest
    "https://superembed.stream/movie?imdb=" + imdbId,  // Good fallback
    "https://multiembed.mov/embed/" + imdbId,    // Reliable backup
    "https://2embed.cc/embed/" + imdbId,         // Additional backup
    "https://vidsrc.to/embed/movie/" + imdbId    // Last resort
  ];
  var iframe = document.getElementById("movie-embed");
  var current = 0;
  var timeout = null;
  var loaded = false;

  function tryNextProvider() {
    if (current >= providers.length) {
      console.log('All providers exhausted');
      return;
    }
    
    // Clear any existing timeout
    if (timeout) {
      clearTimeout(timeout);
    }
    
    console.log('Trying provider:', providers[current]);
    iframe.src = providers[current];
    
    // Set timeout for this provider (8 seconds)
    timeout = setTimeout(function() {
      if (!loaded) {
        console.log('Provider timeout, trying next...');
        current++;
        tryNextProvider();
      }
    }, 8000);
    
    current++;
  }

  // Success handler
  iframe.onload = function() {
    loaded = true;
    if (timeout) {
      clearTimeout(timeout);
    }
    console.log('Provider loaded successfully');
  };

  // Error handler
  iframe.onerror = function() {
    console.log('Provider failed, trying next...');
    if (timeout) {
      clearTimeout(timeout);
    }
    if (!loaded) {
      tryNextProvider();
    }
  };

  // Start with first provider
  tryNextProvider();
});
</script>
</body>
</html>
